name: Build and Package StarMade Launcher
on:
    workflow_dispatch:
jobs:
    build-jar:
        name: Build JAR
        runs-on: ubuntu-latest
        
        steps:
            -   uses: actions/checkout@v3
            
            -   name: Set up JDK 23
                uses: actions/setup-java@v3
                with:
                    java-version: '23'
                    distribution: 'temurin'
            
            -   name: Grant execute permission for gradlew
                run: chmod +x gradlew
            
            -   name: Build with Gradle
                run: ./gradlew shadowJar
            
            -   name: Upload JAR
                uses: actions/upload-artifact@v3
                with:
                    name: starmade-launcher-jar
                    path: build/libs/StarMade-Launcher-*.jar
    
    package-windows:
        needs: build-jar
        runs-on: windows-latest
        
        steps:
            -   uses: actions/checkout@v3
            
            -   name: Download JAR
                uses: actions/download-artifact@v3
                with:
                    name: starmade-launcher-jar
                    path: native-packages/windows/data
            
            -   name: Setup MinGW
                uses: egor-tensin/setup-mingw@v2
            
            -   name: Compile Windows launcher
                run: |
                    cd src/main/native/windows
                    gcc -o StarMade-Launcher.exe launcher.c -mwindows
            
            -   name: Set icon with Resource Hacker
                run: |
                    curl -L -o reshacker.exe http://www.angusj.com/resourcehacker/resource_hacker.zip
                    unzip reshacker.exe
                    ResourceHacker.exe -open StarMade-Launcher.exe -save StarMade-Launcher.exe -action addoverwrite -res src/main/resources/starmade.ico -mask ICONGROUP,MAINICON,
            
            -   name: Package Windows distribution
                run: |
                    mkdir -p native-packages/windows/package
                    cp StarMade-Launcher.exe native-packages/windows/package/
                    cp -r native-packages/windows/data/* native-packages/windows/package/
                    cp StarMade-dedicated-server-windows.bat native-packages/windows/package/
            
            -   name: Create ZIP archive
                run: |
                    cd native-packages/windows/package
                    7z a ../StarMade-Launcher-Windows.zip *
            
            -   name: Upload Windows package
                uses: actions/upload-artifact@v3
                with:
                    name: starmade-launcher-windows
                    path: native-packages/windows/StarMade-Launcher-Windows.zip
    
    package-macos:
        needs: build-jar
        runs-on: macos-latest
        
        steps:
            -   uses: actions/checkout@v3
            
            -   name: Download JAR
                uses: actions/download-artifact@v3
                with:
                    name: starmade-launcher-jar
                    path: native-packages/macos/StarMade-Launcher.app/Contents/Resources/
            
            -   name: Create app bundle structure
                run: |
                    mkdir -p "native-packages/macos/StarMade-Launcher.app/Contents/MacOS"
                    mkdir -p "native-packages/macos/StarMade-Launcher.app/Contents/Resources"
            
            -   name: Create Info.plist
                run: |
                    cat > "native-packages/macos/StarMade Launcher.app/Contents/Info.plist" << EOF
                    <?xml version="1.0" encoding="UTF-8"?>
                    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
                    <plist version="1.0">
                    <dict>
                        <key>CFBundleExecutable</key>
                        <string>StarMade-Launcher</string>
                        <key>CFBundleIconFile</key>
                        <string>AppIcon</string>
                        <key>CFBundleIdentifier</key>
                        <string>org.starmade.launcher</string>
                        <key>CFBundleInfoDictionaryVersion</key>
                        <string>6.0</string>
                        <key>CFBundleName</key>
                        <string>StarMade Launcher</string>
                        <key>CFBundlePackageType</key>
                        <string>APPL</string>
                        <key>CFBundleShortVersionString</key>
                        <string>3.3.0</string>
                        <key>CFBundleVersion</key>
                        <string>3.3.0</string>
                        <key>NSHighResolutionCapable</key>
                        <true/>
                    </dict>
                    </plist>
                    EOF
            
            -   name: Compile launcher script
                run: |
                    cat > "native-packages/macos/StarMade-Launcher.app/Contents/MacOS/StarMade-Launcher" << EOF
                    #!/bin/bash
                    cd "\$(dirname "\$0")"
                    cd ../Resources
                    
                    # Make sure we're using the bundled Java
                    export JAVA_HOME="\$PWD/jre23"
                    
                    # Run the launcher
                    "\$JAVA_HOME/bin/java" -jar "StarMade-Launcher.jar" "\$@"
                    EOF
                    chmod +x "native-packages/macos/StarMade-Launcher.app/Contents/MacOS/StarMade-Launcher"
            
            -   name: Convert icon
                run: |
                    mkdir -p "native-packages/macos/StarMade-Launcher.app/Contents/Resources"
                    cp src/main/resources/starmade.icns "native-packages/macos/StarMade-Launcher.app/Contents/Resources/AppIcon.icns"
            
            -   name: Copy server script
                run: |
                    cp StarMade-dedicated-server-macos.command native-packages/macos/
                    chmod +x native-packages/macos/StarMade-dedicated-server-macos.command
            
            -   name: Create .tar.gz archive
                run: |
                    cd native-packages/macos
                    tar -czf StarMade-Launcher-macos.tar.gz StarMade-Launcher.app StarMade-dedicated-server-macos.command
            
            -   name: Upload macOS package
                uses: actions/upload-artifact@v3
                with:
                    name: starmade-launcher-macos
                    path: native-packages/macos/StarMade-Launcher-macos.tar.gz
    
    package-linux:
        needs: build-jar
        runs-on: ubuntu-latest
        
        steps:
            -   uses: actions/checkout@v3
            
            -   name: Download JAR
                uses: actions/download-artifact@v3
                with:
                    name: starmade-launcher-jar
                    path: native-packages/linux/opt/StarMade-Launcher/
            
            -   name: Create directory structure
                run: |
                    mkdir -p native-packages/linux/opt/Starmade-Launcher
                    mkdir -p native-packages/linux/usr/bin
                    mkdir -p native-packages/linux/usr/share/applications
                    mkdir -p native-packages/linux/usr/share/icons/hicolor/512x512/apps
            
            -   name: Create launcher script
                run: |
                    cat > native-packages/linux/usr/bin/Starmade-Mauncher << EOF
                    #!/bin/bash
                    cd /opt/StarMade-Launcher
                    
                    # Make sure we're using the bundled Java
                    export JAVA_HOME="/opt/StarMade-Launcher/jre23"
                    
                    # Run the launcher
                    "\$JAVA_HOME/bin/java" -jar StarMade-Launcher.jar "\$@"
                    EOF
                    chmod +x native-packages/linux/usr/bin/StarMade-Launcher
            
            -   name: Create desktop entry
                run: |
                    cat > native-packages/linux/usr/share/applications/StarMade-Launcher.desktop << EOF
                    [Desktop Entry]
                    Type=Application
                    Name=StarMade Launcher
                    Comment=Launcher for StarMade
                    Exec=Starmade-Launcher
                    Icon=starmade-launcher
                    Terminal=false
                    Categories=Game;
                    EOF
            
            -   name: Copy icon
                run: |
                    cp src/main/resources/starmade.png native-packages/linux/usr/share/icons/hicolor/512x512/apps/starmade-launcher.png
            
            -   name: Copy server script
                run: |
                    cp StarMade-dedicated-server-linux.sh native-packages/linux/opt/StarMade-Launcher/
                    chmod +x native-packages/linux/opt/StarMade-Launcher/StarMade-dedicated-server-linux.sh
            
            -   name: Create tar.gz archive
                run: |
                    cd native-packages/linux
                    tar -czf ../StarMade-Launcher-Linux.tar.gz opt usr
            
            -   name: Upload Linux packages
                uses: actions/upload-artifact@v3
                with:
                    name: starmade-launcher-linux
                    path: |
                        native-packages/StarMade-Launcher-Linux.tar.gz