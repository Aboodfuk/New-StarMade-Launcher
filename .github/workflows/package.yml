name: 'Build and Upload'
on: workflow_dispatch
jobs:
    build-executables:
        name: 'Build Executables'
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ ubuntu-latest, windows-latest, macos-latest ]
        permissions:
            contents: write
            pull-requests: write
            repository-projects: write
        steps:
            -   name: 'Checkout'
                uses: actions/checkout@v4
            -   name: 'Setup Java 18'
                uses: graalvm/setup-graalvm@v1
                with:
                    java-version: 21
                    distribution: 'graalvm'
                    github-token: ${{ secrets.GITHUB_TOKEN }}
                    native-image-job-reports: 'true'
            -   name: 'Build Jar'
                run: |
                    ./gradlew package
            -   name: 'Change Directory to ./Starter'
                run: |
                    cd Starter
            -   name: 'Build Executable'
                run: |
                    ./gradlew package
            -   name: 'Upload Build Artifacts'
                uses: actions/upload-artifact@v4
                with:
                    name: starmade-launcher-${{ matrix.os }}
                    path: ./release-builds
    publish-executables:
        name: 'Publish Executables'
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
            repository-projects: write
        needs: build-executables
        steps:
            -   name: 'Checkout'
                uses: actions/checkout@v3
            -   name: 'Download Build Artifacts (Linux)'
                uses: actions/download-artifact@v4
                with:
                    name: starmade-launcher-ubuntu-latest
                    path: ./release-builds
                    merge-multiple: true
            -   name: 'Download Build Artifacts (Windows)'
                uses: actions/download-artifact@v4
                with:
                    name: starmade-launcher-windows-latest
                    path: ./release-builds
                    merge-multiple: true
            -   name: 'Download Build Artifacts (MacOS)'
                uses: actions/download-artifact@v4
                with:
                    name: starmade-launcher-macos-latest
                    path: ./release-builds
                    merge-multiple: true
            -   name: 'Set Version Number'
                run: |
                    echo "VERSION=$(./gradlew properties -q | grep "version: " | awk '{print $2}')" >> $GITHUB_ENV
            -   name: 'Create Linux Archive'
                run: |
                    zip -r starmade-launcher-ubuntu-latest.zip ./release-builds/ubuntu-latest
            -   name: 'Create Windows Archive'
                run: |
                    zip -r starmade-launcher-windows-latest.zip ./release-builds/windows-latest
            -   name: 'Create MacOS Archive'
                run: |
                    zip -r starmade-launcher-macos-latest.zip ./release-builds/macos-latest
            -   name: 'Create Release'
                id: create_release
                uses: actions/create-release@v1
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                with:
                    tag_name: v${{ env.VERSION }}
                    release_name: v${{ env.VERSION }}
                    draft: true
                    prerelease: false
            -   name: 'Upload Release Asset (Linux)'
                uses: actions/upload-release-asset@v1
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                with:
                    upload_url: ${{ steps.create_release.outputs.upload_url }}
                    asset_path: starmade-launcher-ubuntu-latest.zip
                    asset_name: starmade-launcher-ubuntu-latest.zip
                    asset_content_type: application/zip
            -   name: 'Upload Release Asset (Windows)'
                uses: actions/upload-release-asset@v1
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                with:
                    upload_url: ${{ steps.create_release.outputs.upload_url }}
                    asset_path: starmade-launcher-windows-latest.zip
                    asset_name: starmade-launcher-windows-latest.zip
                    asset_content_type: application/zip
            -   name: 'Upload Release Asset (MacOS)'
                uses: actions/upload-release-asset@v1
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                with:
                    upload_url: ${{ steps.create_release.outputs.upload_url }}
                    asset_path: starmade-launcher-macos-latest.zip
                    asset_name: starmade-launcher-macos-latest.zip
                    asset_content_type: application/zip